<!--
Merge multiple .pdf files, offline, using pdf-lib
Ref https://pdf-lib.js.org/
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Merge</title>
        <script src="pdf-lib.min.js"></script>

</head>
<body>
    <!-- File input box and button to confirm files selected -->
    <input type="file" id="fileInput" multiple>
    <button onclick="mergePDFs()">Merge all PDFs</button>

    <script>
        async function mergePDFs() {
            const fileInput = document.getElementById('fileInput'); //targets fileInput input id
            const files = Array.from(fileInput.files); //array 'files' to store all pdf files

            //error condition only one pdf provided
            if (files.length < 2) {
                alert("Select at least two PDF files to merge.");
                return;
            }

            const mergedPdf = await PDFLib.PDFDocument.create(); //create PDFDocument using PDFLib
            for (const file of files) {
                const reader = new FileReader(); //reader as defined from FileReader() https://developer.mozilla.org/en-US/docs/Web/API/FileReader

                reader.readAsArrayBuffer(file); //reads in file, ends in a 'result' i.e reader.result
                await readerLoadPromise(reader); //waits for file to be read before continuing

                const pdfBytes = new Uint8Array(reader.result);
                const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes); //pdf-lib load pages from pdfBytes into pdfDoc, can then get each page from first file and add to a new document called mergedPdf

                const copiedPages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
                copiedPages.forEach((page) => {//forEach loop to go through each page and copy it, gets added to mergedPdf
                    mergedPdf.addPage(page);
                });
            }

            const mergedPdfBytes = await mergedPdf.save(); //mergedPdfBytes defined as the saved/final version of mergedPdf at this point. But await the file to finish saving
            const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });//creates the new file as a pdf type blob
            const blobUrl = URL.createObjectURL(blob);
            window.open(blobUrl);//open in a new window, user can then review and choose to save the file as they see fit
        }

        function readerLoadPromise(reader) { //in javascript we need to resolve the promise, either the javascript code succeeded (resolved) or failed (reject). Can throw an error at this stage if something broke.
            return new Promise((resolve, reject) => {
                reader.onload = () => resolve();
                reader.onerror = (error) => reject(error);
            });
        }
    </script>
</body>
</html>
